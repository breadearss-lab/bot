import logging 
from telegram import Update, LabeledPrice
from telegram.ext import ( Application, CommandHandler, CallbackQueryHandler, PreCheckoutQueryHandler, MessageHandler, filters, ContextTypes )


from config import *
from database import Database
from utils import *
from games.roulette import Roulette 
from games.blackjack import Blackjack
from games.poker import TexasHoldem 
from games.chess import Chess


logging.basicConfig( format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO )
logger = logging.getLogger(name)


db = Database(DATABASE_NAME)


roulette = Roulette()
blackjack = Blackjack()
poker = TexasHoldem() 
chess = Chess()


active_games = {}

#============ КОМАНДЫ БОТА =============
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE): """Обработка команды /start"""
user = update.effective_user

# Добавляем пользователя в БД если его нет
db.add_user(user.id, user.username or user.first_name, START_BALANCE)

balance = db.get_balance(user.id)

welcome_text = f"""
🎰 Добро пожаловать в Telegram Casino!

Привет, {user.first_name}!

Ваш стартовый баланс: {balance} ⭐

🎮 Доступные игры: 🃏 Покер (Техасский холдем) 🎰 Рулетка (Американская) 🂡 Блекджек ♟️ Шахматы

Выберите игру из меню ниже: """

await update.message.reply_text(
    welcome_text,
    reply_markup=create_main_menu(),
    parse_mode='HTML'
)
async def check_balance(update: Update, context: ContextTypes.DEFAULT_TYPE): """Проверка баланса""" 
query = update.callback_query 
await query.answer()

user_id = query.from_user.id
balance = db.get_balance(user_id)

text = f"""
💰 Ваш баланс

Текущий баланс: {balance} ⭐

Вы можете пополнить баланс, купив звёзды через Telegram Stars. """

keyboard = [
    [InlineKeyboardButton("⭐ Купить звёзды", callback_data="buy_stars")],
    [InlineKeyboardButton("◀️ Назад", callback_data="back_to_menu")]
]

await query.edit_message_text(
    text,
    reply_markup=InlineKeyboardMarkup(keyboard),
    parse_mode='HTML'
)
async def show_stats(update: Update, context: ContextTypes.DEFAULT_TYPE): """Показать статистику игрока"""
query = update.callback_query 
await query.answer()

user_id = query.from_user.id
stats = db.get_user_stats(user_id)

text = format_stats(stats)

await query.edit_message_text(
    text,
    reply_markup=create_back_button(),
    parse_mode='HTML'
)
#============ ПОКУПКА ЗВЁЗД =============
async def buy_stars_menu(update: Update, context: ContextTypes.DEFAULT_TYPE): """Меню покупки звёзд"""
query = update.callback_query 
await query.answer()

text = """
⭐ Купить звёзды

Выберите пакет звёзд для покупки: """

keyboard = [
    [InlineKeyboardButton("💎 50 звёзд - 50 ⭐", callback_data="purchase_50")],
    [InlineKeyboardButton("💎 100 звёзд - 100 ⭐", callback_data="purchase_100")],
    [InlineKeyboardButton("💎 500 звёзд - 500 ⭐", callback_data="purchase_500")],
    [InlineKeyboardButton("💎 1000 звёзд - 1000 ⭐", callback_data="purchase_1000")],
    [InlineKeyboardButton("◀️ Назад", callback_data="back_to_menu")]
]

await query.edit_message_text(
    text,
    reply_markup=InlineKeyboardMarkup(keyboard),
    parse_mode='HTML'
)
async def process_purchase(update: Update, context: ContextTypes.DEFAULT_TYPE): """Обработка покупки звёзд"""
query = update.callback_query
await query.answer()

# Получаем количество звёзд из callback_data
amount = int(query.data.split('_')[1])

# Создаём инвойс для оплаты через Telegram Stars
title = f"{amount} звёзд"
description = f"Пополнение баланса на {amount} звёзд"
payload = f"stars_{amount}_{query.from_user.id}"
currency = "XTR"  # Telegram Stars

prices = [LabeledPrice(label=f"{amount} ⭐", amount=amount)]

await context.bot.send_invoice(
    chat_id=query.message.chat_id,
    title=title,
    description=description,
    payload=payload,
    provider_token="",  # Для Telegram Stars не нужен
    currency=currency,
    prices=prices
)
async def precheckout_callback(update: Update, context: ContextTypes.DEFAULT_TYPE): """Проверка перед оплатой"""
query = update.pre_checkout_query

# Всегда подтверждаем
await query.answer(ok=True)
async def successful_payment(update: Update, context: ContextTypes.DEFAULT_TYPE): """Обработка успешной оплаты""" 
payment = update.message.successful_payment 
payload = payment.invoice_payload

# Извлекаем данные из payload
_, amount, user_id = payload.split('_')
amount = int(amount)
user_id = int(user_id)

# Пополняем баланс
db.update_balance(user_id, amount)
db.add_transaction(user_id, "purchase", amount, "buy_stars")

new_balance = db.get_balance(user_id)

await update.message.reply_text(
    f"✅ Оплата прошла успешно!\n\n"
    f"Вам начислено: {amount} ⭐\n"
    f"Новый баланс: {new_balance} ⭐",
    reply_markup=create_main_menu()
)
#============ РУЛЕТКА =============
async def start_roulette(update: Update, context: ContextTypes.DEFAULT_TYPE): """Начало игры в рулетку"""
query = update.callback_query
await query.answer()

text = """
🎰 Американская рулетка

Выберите тип ставки:

🔴 Красное - выигрыш x2 ⚫ Чёрное - выигрыш x2 🟢 Зеро (0) - выигрыш x35 1-18 - выигрыш x2 19-36 - выигрыш x2 Чётное - выигрыш x2 Нечётное - выигрыш x2 """

await query.edit_message_text(
    text,
    reply_markup=roulette.create_bet_menu(),
    parse_mode='HTML'
)
async def roulette_bet_type(update: Update, context: ContextTypes.DEFAULT_TYPE): """Выбор типа ставки в рулетке"""
query = update.callback_query 
await query.answer()

bet_type = query.data.split('_')[-1]
user_id = query.from_user.id

# Сохраняем тип ставки
if user_id not in active_games:
    active_games[user_id] = {}
active_games[user_id]['roulette_bet_type'] = bet_type

# Предлагаем выбрать размер ставки
bets = [5, 10, 20, 50, 100]
text = f"Выберите размер ставки для рулетки:"

await query.edit_message_text(
    text,
    reply_markup=create_bet_keyboard('roulette', bets)
)
async def roulette_place_bet(update: Update, context: ContextTypes.DEFAULT_TYPE): """Размещение ставки и запуск рулетки"""
query = update.callback_query 
await query.answer()

user_id = query.from_user.id
bet_amount = int(query.data.split('_')[-1])

# Проверяем баланс
balance = db.get_balance(user_id)
if balance < bet_amount:
    await query.answer("❌ Недостаточно средств!", show_alert=True)
    return

# Получаем тип ставки
bet_type = active_games.get(user_id, {}).get('roulette_bet_type', 'red')

# Снимаем ставку
db.update_balance(user_id, -bet_amount)
db.add_transaction(user_id, "roulette", bet_amount, "bet")

# Крутим рулетку
result, win, message = roulette.spin(bet_type, bet_amount)

# Начисляем выигрыш если есть
if win > 0:
    db.update_balance(user_id, win)
    db.add_transaction(user_id, "roulette", win, "win")
    db.update_game_stats(user_id, "roulette", True, bet_amount, win)
else:
    db.update_game_stats(user_id, "roulette", False, bet_amount, 0)

new_balance = db.get_balance(user_id)

full_message = f"{message}\n\n{format_balance(new_balance)}"

keyboard = [
    [InlineKeyboardButton("🔄 Играть ещё", callback_data="game_roulette")],
    [InlineKeyboardButton("◀️ Главное меню", callback_data="back_to_menu")]
]

await query.edit_message_text(
    full_message,
    reply_markup=InlineKeyboardMarkup(keyboard)
)

# Очищаем данные игры
if user_id in active_games:
    active_games[user_id].pop('roulette_bet_type', None)
#============= БЛЕКДЖЕК =============
async def start_blackjack(update: Update, context: ContextTypes.DEFAULT_TYPE): """Начало игры в блекджек"""
query = update.callback_query 
await query.answer()

text = "🂡 <b>Блекджек</b>\n\nВыберите размер ставки:"
bets = [5, 10, 20, 50]

await query.edit_message_text(
    text,
    reply_markup=create_bet_keyboard('blackjack', bets),
    parse_mode='HTML'
)
async def blackjack_place_bet(update: Update, context: ContextTypes.DEFAULT_TYPE): """Начало раздачи в блекджеке"""
query = update.callback_query
await query.answer()

user_id = query.from_user.id
bet_amount = int(query.data.split('_')[-1])

# Проверяем баланс
balance = db.get_balance(user_id)
if balance < bet_amount:
    await query.answer("❌ Недостаточно средств!", show_alert=True)
    return

# Снимаем ставку
db.update_balance(user_id, -bet_amount)
db.add_transaction(user_id, "blackjack", bet_amount, "bet")

# Создаём колоду и раздаём карты
deck = blackjack.create_deck()
player_hand = [deck.pop(), deck.pop()]
dealer_hand = [deck.pop(), deck.pop()]

# Сохраняем состояние игры
active_games[user_id] = {
    'game': 'blackjack',
    'deck': deck,
    'player_hand': player_hand,
    'dealer_hand': dealer_hand,
    'bet': bet_amount
}

player_value = blackjack.calculate_hand(player_hand)
dealer_visible = dealer_hand[0]

# Проверяем на блекджек
if player_value == 21:
    await blackjack_finish_game(query, user_id, "blackjack")
    return

text = f"🂡 <b>Блекджек</b>\n\n"
text += f"Ваши карты: {blackjack.format_hand(player_hand)}\n"
text += f"Ваши очки: {player_value}\n\n"
text += f"Карта дилера: {dealer_visible[0]}{dealer_visible[1]} ❓\n\n"
text += f"Ставка: {bet_amount} ⭐"

await query.edit_message_text(
    text,
    reply_markup=blackjack.create_game_keyboard(),
    parse_mode='HTML'
)
async def blackjack_hit(update: Update, context: ContextTypes.DEFAULT_TYPE): """Игрок берёт карту"""
query = update.callback_query 
await query.answer()

user_id = query.from_user.id

if user_id not in active_games or active_games[user_id].get('game') != 'blackjack':
    await query.answer("❌ Игра не найдена", show_alert=True)
    return

game = active_games[user_id]
game['player_hand'].append(game['deck'].pop())

player_value = blackjack.calculate_hand(game['player_hand'])
dealer_visible = game['dealer_hand'][0]

text = f"🂡 <b>Блекджек</b>\n\n"
text += f"Ваши карты: {blackjack.format_hand(game['player_hand'])}\n"
text += f"Ваши очки: {player_value}\n\n"
text += f"Карта дилера: {dealer_visible[0]}{dealer_visible[1]} ❓\n\n"
text += f"Ставка: {game['bet']} ⭐"

# Проверяем перебор
if player_value > 21:
    await blackjack_finish_game(query, user_id, "bust")
    return

await query.edit_message_text(
    text,
    reply_markup=blackjack.create_game_keyboard(),
    parse_mode='HTML'
)
async def blackjack_stand(update: Update, context: ContextTypes.DEFAULT_TYPE): """Игрок остановился"""
query = update.callback_query
await query.answer()

user_id = query.from_user.id

if user_id not in active_games or active_games[user_id].get('game') != 'blackjack':
    await query.answer("❌ Игра не найдена", show_alert=True)
    return

await blackjack_finish_game(query, user_id, "stand")
async def blackjack_finish_game(query, user_id, reason): """Завершение игры в блекджек"""
game = active_games[user_id]

# Дилер играет
dealer_hand = blackjack.dealer_play(game['deck'], game['dealer_hand'])

player_value = blackjack.calculate_hand(game['player_hand'])
dealer_value = blackjack.calculate_hand(dealer_hand)

# Определяем победителя
multiplier, result_message = blackjack.check_winner(player_value, dealer_value)
win = int(game['bet'] * multiplier)

# Начисляем выигрыш
if win > 0:
    db.update_balance(user_id, win)
    db.add_transaction(user_id, "blackjack", win, "win")
    db.update_game_stats(user_id, "blackjack", multiplier >= 2, game['bet'], win)
else:
    db.update_game_stats(user_id, "blackjack", False, game['bet'], 0)

new_balance = db.get_balance(user_id)

text = f"🂡 <b>Блекджек - Результат</b>\n\n"
text += f"Ваши карты: {blackjack.format_hand(game['player_hand'])}\n"
text += f"Ваши очки: {player_value}\n\n"
text += f"Карты дилера: {blackjack.format_hand(dealer_hand)}\n"
text += f"Очки дилера: {dealer_value}\n\n"
text += f"{result_message}\n\n"
if win > 0:
    text += f"Выигрыш: {win} ⭐\n"
text += f"{format_balance(new_balance)}"

keyboard = [
    [InlineKeyboardButton("🔄 Играть ещё", callback_data="game_blackjack")],
    [InlineKeyboardButton("◀️ Главное меню", callback_data="back_to_menu")]
]

await query.edit_message_text(
    text,
    reply_markup=InlineKeyboardMarkup(keyboard),
    parse_mode='HTML'
)

# Очищаем игру
del active_games[user_id]
#============= ПОКЕР =============
async def start_poker(update: Update, context: ContextTypes.DEFAULT_TYPE): """Начало игры в покер"""
query = update.callback_query
await query.answer()

text = """
🃏 Техасский Холдем

Упрощённая версия покера против бота.

Правила: - Вы и бот получаете по 2 карты - На стол выкладывается 5 общих карт - Лучшая комбинация из 5 карт побеждает

Выберите размер ставки: """

bets = [10, 20, 50, 100]

await query.edit_message_text(
    text,
    reply_markup=create_bet_keyboard('poker', bets),
    parse_mode='HTML'
)
async def poker_place_bet(update: Update, context: ContextTypes.DEFAULT_TYPE): """Начало раздачи в покере"""
query = update.callback_query
await query.answer()

user_id = query.from_user.id
bet_amount = int(query.data.split('_')[-1])

# Проверяем баланс
balance = db.get_balance(user_id)
if balance < bet_amount:
    await query.answer("❌ Недостаточно средств!", show_alert=True)
    return

# Снимаем ставку
db.update_balance(user_id, -bet_amount)
db.add_transaction(user_id, "poker", bet_amount, "bet")

# Создаём колоду и раздаём карты
deck = poker.create_deck()
player_hand = [deck.pop(), deck.pop()]
bot_hand = [deck.pop(), deck.pop()]
community = []

# Сохраняем состояние игры
active_games[user_id] = {
    'game': 'poker',
    'deck': deck,
    'player_hand': player_hand,
    'bot_hand': bot_hand,
    'community': community,
    'bet': bet_amount,
    'stage': 'preflop'
}

text = f"🃏 <b>Техасский Холдем</b>\n\n"
text += f"Ваши карты: {poker.format_cards(player_hand)}\n\n"
text += f"Общие карты: (пусто)\n\n"
text += f"Ставка: {bet_amount} ⭐\n\n"
text += f"Бот делает ставку..."

keyboard = [
    [InlineKeyboardButton("👀 Показать флоп", callback_data="poker_flop")],
    [InlineKeyboardButton("❌ Сдаться", callback_data="poker_fold")]
]

await query.edit_message_text(
    text,
    reply_markup=InlineKeyboardMarkup(keyboard),
    parse_mode='HTML'
)
async def poker_flop(update: Update, context: ContextTypes.DEFAULT_TYPE): """Показ флопа (3 карты)"""
query = update.callback_query 
await query.answer()

user_id = query.from_user.id

if user_id not in active_games or active_games[user_id].get('game') != 'poker':
    await query.answer("❌ Игра не найдена", show_alert=True)
    return

game = active_games[user_id]

# Выкладываем флоп (3 карты)
game['community'] = [game['deck'].pop(), game['deck'].pop(), game['deck'].pop()]
game['stage'] = 'flop'

text = f"🃏 <b>Техасский Холдем - Флоп</b>\n\n"
text += f"Ваши карты: {poker.format_cards(game['player_hand'])}\n\n"
text += f"Общие карты: {poker.format_cards(game['community'])}\n\n"
text += f"Ставка: {game['bet']} ⭐"

keyboard = [
    [InlineKeyboardButton("👀 Показать терн", callback_data="poker_turn")],
    [InlineKeyboardButton("❌ Сдаться", callback_data="poker_fold")]
]

await query.edit_message_text(
    text,
    reply_markup=InlineKeyboardMarkup(keyboard),
    parse_mode='HTML'
)
async def poker_turn(update: Update, context: ContextTypes.DEFAULT_TYPE): """Показ терна (4-я карта)"""
query = update.callback_query
await query.answer()

user_id = query.from_user.id
game = active_games[user_id]

# Добавляем терн
game['community'].append(game['deck'].pop())
game['stage'] = 'turn'

text = f"🃏 <b>Техасский Холдем - Терн</b>\n\n"
text += f"Ваши карты: {poker.format_cards(game['player_hand'])}\n\n"
text += f"Общие карты: {poker.format_cards(game['community'])}\n\n"
text += f"Ставка: {game['bet']} ⭐"

keyboard = [
    [InlineKeyboardButton("👀 Показать ривер", callback_data="poker_river")],
    [InlineKeyboardButton("❌ Сдаться", callback_data="poker_fold")]
]

await query.edit_message_text(
    text,
    reply_markup=InlineKeyboardMarkup(keyboard),
    parse_mode='HTML'
)
async def poker_river(update: Update, context: ContextTypes.DEFAULT_TYPE): """Показ ривера (5-я карта) и вскрытие""" 
query = update.callback_query 
await query.answer()

user_id = query.from_user.id
game = active_games[user_id]

# Добавляем ривер
game['community'].append(game['deck'].pop())
game['stage'] = 'river'

# Вскрытие
await poker_showdown(query, user_id)
async def poker_showdown(query, user_id): """Вскрытие карт и определение победителя""" 
game = active_games[user_id]

# Объединяем карты игрока и бота с общими
player_cards = game['player_hand'] + game['community']
bot_cards = game['bot_hand'] + game['community']

# Оцениваем руки
player_rank, player_value, player_combo = poker.evaluate_hand(player_cards)
bot_rank, bot_value, bot_combo = poker.evaluate_hand(bot_cards)

# Определяем победителя
if player_rank > bot_rank or (player_rank == bot_rank and player_value > bot_value):
    win = game['bet'] * 2
    result = "🎉 Вы победили!"
    won = True
elif player_rank == bot_rank and player_value == bot_value:
    win = game['bet']
    result = "🤝 Ничья! Ставка возвращена."
    won = False
else:
    win = 0
    result = "😢 Бот победил!"
    won = False

# Начисляем выигрыш
if win > 0:
    db.update_balance(user_id, win)
    db.add_transaction(user_id, "poker", win, "win")